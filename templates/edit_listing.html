{% extends 'home.html' %}
{% block content %}
<div class="container mt-5">
    <h2>Edit Listing</h2>
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="delete_image_ids" id="delete_image_ids_input">
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ listing.title }}" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="4" required>{{ listing.description }}</textarea>
        </div>
        <div class="mb-3">
            <label for="price" class="form-label">Price</label>
            <input type="number" step="0.01" class="form-control" id="price" name="price" value="{{ listing.price }}" required>
        </div>
        <div class="mb-3">
            <label for="location" class="form-label">Location</label>
            <input type="text" class="form-control" id="location" name="location" value="{{ listing.location }}" placeholder="Enter city or region" required>
        </div>
        <div class="mb-3">
            <label for="category" class="form-label">Category</label>
            <select class="form-select" id="category" name="category" required>
                <option value="">Select a category</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if listing.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        {% if listing.images %}
        <div class="mb-3">
            <label class="form-label">Current Images (select one as cover):</label>
            <div class="d-flex flex-wrap">
                {% for img in listing.images %}
                <div class="me-2 mb-2 d-flex flex-column align-items-center image-item" style="width:100px;" data-img-id="{{ img.id }}">
                    <img src="{{ url_for('uploaded_file', filename=img.filename) }}" class="img-thumbnail" style="max-width:100px;">
                    <div class='form-check mt-1'>
                      <input class='form-check-input cover-radio' type='radio' name='cover_radio_existing' id='cover_radio_existing_{{ img.id }}' value='{{ img.id }}' {% if img.is_cover %}checked{% endif %}>
                      <label class='form-check-label small' for='cover_radio_existing_{{ img.id }}'>Set as cover</label>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger mt-1 delete-btn" data-img-id="{{ img.id }}">Delete</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="mb-3">
            <label for="images" class="form-label">Add Images (you can select multiple)</label>
            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple onchange="previewImagesEdit()">
            <div id="image-preview-list-edit" class="d-flex flex-wrap mt-2"></div>
        </div>
        <button type="submit" class="btn btn-primary">Update Listing</button>
        <a href="{{ url_for('listing_detail', listing_id=listing.id) }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
function previewImagesEdit() {
    const input = document.getElementById('images');
    const preview = document.getElementById('image-preview-list-edit');
    preview.innerHTML = '';
    const files = input.files;
    if (!files || files.length === 0) return;
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'me-2 mb-2 d-flex flex-column align-items-center';
            div.style.width = '100px';
            div.innerHTML = `
                <img src="${e.target.result}" style="width:100px;height:100px;object-fit:contain;border:1px solid #ccc;background:#fff;">
                <div class='form-check mt-1'>
                  <input class='form-check-input' type='radio' name='cover_index_new' id='cover_radio_new_${i}' value='${i}'>
                  <label class='form-check-label small' for='cover_radio_new_${i}'>Set as cover</label>
                </div>
            `;
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let deleteImageIds = [];
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const imgId = btn.getAttribute('data-img-id');
            if (!deleteImageIds.includes(imgId)) {
                deleteImageIds.push(imgId);
                btn.closest('.image-item').remove();
                document.getElementById('delete_image_ids_input').value = deleteImageIds.join(',');
            }
        });
    });
    
    function updateCoverHighlight() {
        document.querySelectorAll('.cover-radio').forEach(function(radio) {
            const parent = radio.closest('.image-item');
            if (radio.checked) {
                parent.style.boxShadow = '0 0 0 2px #dc3545';
            } else {
                parent.style.boxShadow = '';
            }
        });
    }
    
    document.querySelectorAll('.cover-radio').forEach(function(radio) {
        radio.addEventListener('change', updateCoverHighlight);
    });
    updateCoverHighlight();
});
</script>

{% endblock %} 
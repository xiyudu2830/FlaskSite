{% extends 'home.html' %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            {% if listing.images and listing.images|length > 0 %}
            {% set cover_img = listing.images|selectattr('is_cover')|first %}
            {% set other_imgs = listing.images|rejectattr('is_cover')|list %}
            <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% if cover_img %}
                    <div class="carousel-item active">
                        <img src="{{ url_for('uploaded_file', filename=cover_img.filename) }}" class="d-block w-100" style="max-height:400px; object-fit:contain;" alt="Listing Image">
                    </div>
                    {% endif %}
                    {% for img in other_imgs %}
                    <div class="carousel-item {% if not cover_img and loop.index0 == 0 %}active{% endif %}">
                        <img src="{{ url_for('uploaded_file', filename=img.filename) }}" class="d-block w-100" style="max-height:400px; object-fit:contain;" alt="Listing Image">
                    </div>
                    {% endfor %}
                </div>
                {% if listing.images|length > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
                {% endif %}
            </div>
            {% else %}
            <img src="https://via.placeholder.com/400x300?text=No+Image" class="img-fluid" alt="No Image">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h2>{{ listing.title }}
                {% if current_user.is_authenticated and listing.seller != current_user %}
                <form method="POST" action="{{ url_for('favorite_listing', listing_id=listing.id) }}" style="display:inline;">
                    {% if listing in current_user.favorites %}
                    <button type="submit" formaction="{{ url_for('unfavorite_listing', listing_id=listing.id) }}" class="btn btn-link p-0"><span style="color:#e25555; font-size:1.2em;">&#10084;</span></button>
                    {% else %}
                    <button type="submit" class="btn btn-link p-0"><span style="color:#bbb; font-size:1.2em;">&#9825;</span></button>
                    {% endif %}
                </form>
                {% endif %}
            </h2>
            <p><strong>Price:</strong> ${{ listing.price }}</p>
            <p><strong>Category:</strong> {{ listing.category }}</p>
            {% if listing.location %}
            <p><strong>Location:</strong> {{ listing.location }}</p>
            {% endif %}
            <p>
                {% if listing.status == 'Available' %}
                <span class="badge bg-success">Available</span>
                {% elif listing.status == 'Reserved' %}
                <span class="badge bg-warning text-dark">Reserved</span>
                {% elif listing.status == 'Sold' %}
                <span class="badge bg-danger">Sold</span>
                {% endif %}
            </p>
            <p>{{ listing.description }}</p>
            <p><strong>Seller:</strong> <a href="{{ url_for('user_profile', username=listing.seller.username) }}">{{ listing.seller.username }}</a></p>
            {% if listing.status == 'Reserved' and listing.reserved_by %}
            <p><strong>Reserved by:</strong> <a href="{{ url_for('user_profile', username=listing.reserved_by.username) }}">{{ listing.reserved_by.username }}</a></p>
            {% endif %}
            {% if listing.status == 'Sold' and listing.reserved_by %}
            <p><strong>Bought by:</strong> <a href="{{ url_for('user_profile', username=listing.reserved_by.username) }}">{{ listing.reserved_by.username }}</a></p>
            {% endif %}
            <a href="{{ url_for('listings') }}" class="btn btn-secondary">Back to Listings</a>
            {% if current_user.is_authenticated %}
                {% if listing.status == 'Available' and listing.seller != current_user %}
                <form action="{{ url_for('reserve_listing', listing_id=listing.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-primary">Reserve</button>
                </form>
                {% elif listing.status == 'Reserved' %}
                    {% if current_user == listing.reserved_by %}
                    <form action="{{ url_for('cancel_reservation', listing_id=listing.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-warning">Cancel Reservation</button>
                    </form>
                    {% endif %}
                    {% if current_user == listing.seller %}
                    <form action="{{ url_for('mark_sold', listing_id=listing.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-success ms-2">Mark as Sold</button>
                    </form>
                    <form action="{{ url_for('cancel_reservation', listing_id=listing.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-warning ms-2">Cancel Reservation</button>
                    </form>
                    {% endif %}
                {% elif listing.status == 'Sold' and current_user == listing.seller %}
                <form action="{{ url_for('relist_listing', listing_id=listing.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-info">Relist</button>
                </form>
                {% elif listing.status == 'Reserved' and current_user == listing.seller %}
                <form action="{{ url_for('relist_listing', listing_id=listing.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-info">Relist</button>
                </form>
                {% endif %}
            {% endif %}
            {% if current_user.is_authenticated and current_user.id == listing.seller.id %}
            <a href="{{ url_for('edit_listing', listing_id=listing.id) }}" class="btn btn-warning ms-2">Edit</a>
            <form action="{{ url_for('delete_listing', listing_id=listing.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn btn-danger ms-2" onclick="return confirm('Are you sure you want to delete this listing? This cannot be undone.');">Delete</button>
            </form>
            {% endif %}
            {% if current_user.is_authenticated and current_user.id != listing.seller.id %}
            <hr>
            <h5>Contact Seller</h5>
            <form action="{{ url_for('send_message', recipient_id=listing.seller.id) }}" method="POST">
                <div class="mb-2">
                    <textarea name="content" class="form-control" rows="3" placeholder="Write your message here..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Send Message</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% if listing.status == 'Sold' and current_user.is_authenticated %}
    <hr>
    <h5>Leave a Review</h5>
    {% if current_user == listing.seller and not listing.seller.given_reviews|selectattr('listing','equalto',listing)|selectattr('reviewee','equalto',listing.reserved_by)|list %}
    <form method="POST" action="{{ url_for('submit_review', listing_id=listing.id, reviewee_id=listing.reserved_by.id) }}">
        <div class="mb-2">
            <label for="rating" class="form-label">Rating</label>
            <select class="form-select" id="rating" name="rating" required>
                <option value="">Select</option>
                {% for i in range(5,0,-1) %}
                <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-2">
            <label for="comment" class="form-label">Comment</label>
            <textarea class="form-control" id="comment" name="comment" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review for Buyer</button>
    </form>
    {% elif current_user == listing.reserved_by and not current_user.given_reviews|selectattr('listing','equalto',listing)|selectattr('reviewee','equalto',listing.seller)|list %}
    <form method="POST" action="{{ url_for('submit_review', listing_id=listing.id, reviewee_id=listing.seller.id) }}">
        <div class="mb-2">
            <label for="rating" class="form-label">Rating</label>
            <select class="form-select" id="rating" name="rating" required>
                <option value="">Select</option>
                {% for i in range(5,0,-1) %}
                <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-2">
            <label for="comment" class="form-label">Comment</label>
            <textarea class="form-control" id="comment" name="comment" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review for Seller</button>
    </form>
    {% endif %}
{% endif %}
<hr>
<h5>Reviews for this Listing</h5>
{% for review in listing.reviews %}
<div class="mb-2">
    <b>{{ review.reviewer.username }}</b> rated <b>{{ review.rating }}/5</b> on {{ review.timestamp.strftime('%Y-%m-%d') }}<br>
    <span>{{ review.comment }}</span>
</div>
{% else %}
<p>No reviews yet for this listing.</p>
{% endfor %}
{% if current_user.is_authenticated and current_user.id != listing.seller.id %}
<hr>
<h5>Report this Listing</h5>
<form method="POST" action="{{ url_for('report_listing', listing_id=listing.id) }}">
    <div class="mb-2">
        <textarea name="reason" class="form-control" rows="2" placeholder="Describe the issue (spam, fraud, etc.)" required></textarea>
    </div>
    <button type="submit" class="btn btn-danger btn-sm">Report Listing</button>
</form>
{% endif %}
{% endblock %} 